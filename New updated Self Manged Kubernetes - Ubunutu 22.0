ğŸš€ Kubernetes Cluster Setup using kubeadm (v1.29)

OS        : Ubuntu 22.04
CRI       : Docker (via cri-dockerd)
CNI       : Flannel
Cluster   : 1 Master + 1 Worker
Purpose   : Stable, demo-safe Kubernetes installation

====================================================
ğŸ”¹ PART 1 â€” MASTER NODE SETUP
====================================================

----------------------------------------------------
Step 1: Disable Swap - Kubernetes requires swap to be disabled for proper memory management.
If swap is enabled, kubeadm will fail preflight checks.
Kubernetes does not allow swap because it needs full control over memory management.
swapoff -a disables swap so kubelet can work correctly.
What is Swap (in simple terms)?
Swap = disk space used as extra memory when RAM is full
Slower than RAM
OS may move memory pages between RAM â†” disk - RAM full â†’ OS pushes memory to disk (swap)
----------------------------------------------------
sudo swapoff -a

-----------------------------------------------------------------------------------------------
Step 2: Install Docker (Container Runtime) - Docker will be used as the container runtime for Kubernetes.
------------------------------------------------------------------------------------------------
sudo apt-get update -y
sudo apt-get install -y docker.io

docker --version

sudo systemctl enable docker
sudo systemctl start docker
sudo systemctl status docker

---------------------------------------------------------------------------------------------
Step - Important : Configure Docker to use systemd cgroups
(Required for Kubernetes stability)
--------------------------------------------------------------------------------------------
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF

sudo systemctl daemon-reexec
sudo systemctl restart docker
-----------------------------------------------------------------------------------------------------------------
Step 3: Install cri-dockerd (Docker CRI Adapter) - Kubernetes no longer supports Docker directly.
cri-dockerd acts as a bridge between Kubernetes and Docker.
-----------------------------------------------------------------------------------------------------------------
wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.13/cri-dockerd_0.3.13.3-0.ubuntu-jammy_amd64.deb
sudo dpkg -i cri-dockerd_0.3.13.3-0.ubuntu-jammy_amd64.deb

sudo systemctl daemon-reload
sudo systemctl enable cri-docker.service
sudo systemctl enable cri-docker.socket
sudo systemctl start cri-docker.service
sudo systemctl start cri-docker.socket

Verify CRI socket:
ls -l /var/run/cri-dockerd.sock

-----------------------------------------------------------------------------------------------------------------
Step 4: Enable Required Kernel Modules & Networking - These kernel settings are required for container networking and pod communication.
-----------------------------------------------------------------------------------------------------------------
sudo modprobe overlay
sudo modprobe br_netfilter

sudo tee /etc/sysctl.d/kubernetes.conf <<EOF
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
EOF

sudo sysctl --system

-----------------------------------------------------------------------------------------------------------------
Step 5: Install Kubernetes Components - Install kubeadm (cluster bootstrap), kubelet (node agent),
and kubectl (CLI tool).
-----------------------------------------------------------------------------------------------------------------

sudo apt-get install -y apt-transport-https ca-certificates curl gpg

curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

Verify:
kubeadm version

-----------------------------------------------------------------------------------------------------------------
Step 6: Set Hostname for Master Node - A clear hostname helps identify the control plane node.
-----------------------------------------------------------------------------------------------------------------

sudo hostnamectl set-hostname master-node

(Re-login recommended)

-----------------------------------------------------------------------------------------------------------------
Step 7: Initialize Kubernetes Control Plane - This command bootstraps the Kubernetes master
and explicitly tells kubeadm to use Docker via cri-dockerd.

Flannel uses 10.244.0.0/16 as its default pod network.
When kubeadm initializes the cluster, Kubernetes must be told the same pod CIDR.
If the CIDR doesnâ€™t match, Flannel cannot allocate per-node subnets, /run/flannel/subnet.env is never created, and pod networking fails.
Thatâ€™s why --pod-network-cidr=10.244.0.0/16 is mandatory when using Flannel.
-----------------------------------------------------------------------------------------------------------------

sudo kubeadm init --cri-socket unix:///var/run/cri-dockerd.sock --pod-network-cidr=10.244.0.0/16

IMPORTANT:
Copy and SAVE the "kubeadm join" command shown at the end.

-----------------------------------------------------------------------------------------------------------------
Step 8: Configure kubectl Access (for ubuntu user) - This allows the non-root user to communicate with the cluster.
-----------------------------------------------------------------------------------------------------------------
mkdir -p $HOME/.kube
sudo cp -f /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

Verify:
kubectl cluster-info
kubectl get nodes

Expected:
master-node   NotReady   control-plane

(NotReady is NORMAL before CNI installation)

-----------------------------------------------------------------------------------------------------------------
Step 9: Install Flannel CNI (Pod Network) - Flannel provides pod-to-pod networking.
Without this, nodes will remain NotReady.
-----------------------------------------------------------------------------------------------------------------

kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

Wait 30â€“60 seconds:
kubectl get nodes

Expected:
master-node   Ready   control-plane
______________________________________________________________________________________________________________________________________________________________________________________
====================================================
ğŸ”¹ PART 2 â€” WORKER NODE SETUP
====================================================

âš ï¸ IMPORTANT:
DO NOT run kubeadm init on worker nodes.

-----------------------------------------------------------------------------------------------------------------
Step 1: Disable Swap (Worker) - Required for Kubernetes node operation.
-----------------------------------------------------------------------------------------------------------------

sudo swapoff -a

-----------------------------------------------------------------------------------------------------------------
Step 2: Install Docker (Worker) - Docker is required to run containers on worker nodes.
-----------------------------------------------------------------------------------------------------------------
sudo apt-get update -y
sudo apt-get install -y docker.io
sudo systemctl enable docker
sudo systemctl start docker
------------------------------------------------------------------------------------------------
Step - Important : Configure Docker to use systemd cgroups
(Required for Kubernetes stability)
--------------------------------------------------------------------------------------------------
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF

sudo systemctl daemon-reexec
sudo systemctl restart docker
-----------------------------------------------------------------------------------------------------------------
Step 3: Install cri-dockerd (Worker) - Required to allow Kubernetes to communicate with Docker.
-----------------------------------------------------------------------------------------------------------------
wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.13/cri-dockerd_0.3.13.3-0.ubuntu-jammy_amd64.deb
sudo dpkg -i cri-dockerd_0.3.13.3-0.ubuntu-jammy_amd64.deb

sudo systemctl daemon-reload
sudo systemctl enable cri-docker.service
sudo systemctl enable cri-docker.socket
sudo systemctl start cri-docker.service
sudo systemctl start cri-docker.socket

-----------------------------------------------------------------------------------------------------------------
Step 4: Enable Kernel Modules (Worker) - Required for container networking.
-----------------------------------------------------------------------------------------------------------------
sudo modprobe overlay
sudo modprobe br_netfilter
sudo sysctl --system
---------------------------------------------------------------------------------------------------------------------
Step 5: Install Kubernetes Components (Worker) - Install kubeadm and kubelet to join the cluster.
------------------------------------------------------------------------------------------------------------------
sudo apt-get install -y apt-transport-https ca-certificates curl gpg

curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

-----------------------------------------------------------------------------------------------------------------
Step 6: Set Hostname (Worker Node) - Helps identify the worker in the cluster.
--------------------------------------------------------------------------------------------------------------------
sudo hostnamectl set-hostname worker-node-1

-----------------------------------------------------------------------------------------------------------------
Step 7: Join Worker Node to Cluster
-----------------------------------------------------------------------------------------------------------------
Run the EXACT join command copied from master.
This connects the worker to the control plane.

sudo kubeadm join <MASTER-IP>:6443 --token <TOKEN> --discovery-token-ca-cert-hash sha256:<HASH> --cri-socket unix:///var/run/cri-dockerd.sock
{** - Important - Add this Line at last - --cri-socket unix:///var/run/cri-dockerd.sock}

â³ This may take 1â€“4 minutes. Do NOT interrupt.

====================================================
ğŸ”¹ PART 3 â€” VERIFY CLUSTER
====================================================

Run on MASTER:

kubectl get nodes

Expected Output:
master-node     Ready   control-plane
worker-node-1   Ready   <none>


====================================================
ğŸ” REQUIRED AWS SECURITY GROUP RULE
====================================================

Master Node must allow:

Type       : Custom TCP
Protocol   : TCP
Port       : 6443
Source     : Worker SG or VPC CIDR

If this port is blocked â†’ worker join will TIMEOUT.


====================================================
ğŸ¯ DEMO CHECKLIST
====================================================

âœ” Ubuntu 22.04
âœ” Kubernetes v1.29
âœ” Docker runtime (cri-dockerd)
âœ” Flannel networking
âœ” Master + Worker joined successfully
âœ” Stable & demo-ready
